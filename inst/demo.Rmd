--- 
title: Simple Tables Demo Doc
output: 
  pdf_document: 
    extra_dependencies: 
      threeparttable:
      booktabs:
      mathdesign: utopia
      array:
    number_sections: true
    toc: true 
editor_options: 
  chunk_output_type: inline
---

```{r,message = FALSE, echo=FALSE}
library(dplyr)
wraptable <- function(x) {
  writeLines("\\begin{table}[h]")
  writeLines("\\centering")
  writeLines(x)
  writeLines("\\end{table}")
}
wrap <- wraptable
```

\clearpage

# Data

Mostly working with this data; but some others come in later to illustrate
certain features.

```{r}
library(pmtables)
library(yspec)
spec <- ys_help$spec()

pmdata <- readRDS("datasets/pmdata.RDS")
head(pmdata)
data <- select(pmdata, STUDY = STUDYf, DOSE = DOSEf, WT, AGE, CRCL, ALB, SCR)
```


# wrap

There is a wrap function in this document.  Don't worry about that; it just 
puts the output into a table environment and sends the output to get rendered
in markdown.

\clearpage

# Simple table

- Columns are in bold by default (can be turned off)

```{r,results = 'asis'}
data %>% stable() %>% wrap()
```

\clearpage

# Annotate

- Arguments to identify the name of the generating R script and the output file
  name
- The output file name is retained as an attribute to be used later when saving
  the table data
- Arbitrary notes are also allowed (encouraged)

```{r,results = 'asis'}
stable(
  data, 
  r_file = "foo.R", 
  output_file = "foo.tex", 
  notes = c("Data were analyzed in quadruplicate.", "The results are very clear."),
) %>% wrap()
```


\clearpage

# Align

- Center everything except for
  - `STUDY` (left)
  - `DOSE` and `SCR` (right)

```{r,results = 'asis'}
data %>% 
  stable(align = cols_center(STUDY = 'l', .r = "DOSE,SCR")) %>% wrap()
```


\clearpage


# Units

- Automatically put units under the column name

```{r,results = 'asis'}
units <- ys_get_unit(spec, parens = TRUE)

stable(
  data,
  align = cols_center(STUDY = 'l', .r = "DOSE,SCR"),
  units = units,
) %>% wrap()
```

\clearpage

# Math

- Columns with at least two `$` are "math" and will not be sanitized
- Otherwise the are functions to "prime" the data frame
  - The default is to convert every column to character
  - Then walk the columns, look for non-math columns and sanitize them

```{r}
ptab <- readRDS("datasets/ptab.RDS")
ptab
```


```{r, results = 'asis'}
stable(
  ptab, 
  align = cols_center(Parameter =  col_ragged(3), .l = "Symbol"), 
  panel = ".type"
  ) %>% wrap
```



\clearpage

# hline from column

- Use the column to determine where the hline should go

```{r,results = 'asis'}
stable(
  data,
  hline_from = "STUDY",
) %>% wrap()
```

\clearpage

# hline anywhere

- Give row numbers for hline

```{r,results = 'asis'}
stable(
  data,
  hline_at = c(3,nrow(data))-1,
) %>% wrap()
```


\clearpage

# Remove dups

- Discard repeating values in a column

```{r,results = 'asis'}
stable(
  data,
  hline_from = "STUDY",
  rm_dups = "STUDY",
) %>% wrap()
```

\clearpage

# Panel

- Divide the table using column contents
- there's a bug somewhere there

```{r,results = 'asis'}
stable(
  data,
  align = cols_center(DOSE = "l", SCR = "r"), 
  panel = vars("Study number:" = STUDY)
) %>% wrap()
```

\clearpage

# Colspan

- Group columns

```{r,results = 'asis'}
stable(
  data,
  align = cols_left(.c = "WT,AGE,CRCL"),
  span = colgroup("In final model", WT:CRCL),
) %>% wrap()
```


\clearpage

# Colspan - multiple

- Multiple groupings
- Multiple levels

```{r,results = 'asis'}

stable(
  data,
  panel  = list(Study = "STUDY"),
  align = cols_left(.c = "WT,AGE,CRCL"),
  units = ys_get_unit(spec, parens = TRUE),
  r_file = "foo.R", output_file = "foo.tex",
  span = list(
    colgroup("Meh", DOSE:WT),
    colgroup("Hrm", AGE:CRCL), 
    colgroup("Huh", ALB:SCR), 
    colgroup("Expert opinion", CRCL:SCR, level = 2)
  )
) %>% wrap()
```


\clearpage

# Colspan - from cols

- we have some columns of the form `tag.name`

```{r}
dotdata <- readRDS("datasets/with-dots.RDS")
head(dotdata, n=2)
```

```{r,results = 'asis'}
stable(
  dotdata,
  panel  = c(Study = "STUDY"),
  span_split = colsplit(sep = '.'),
  align = cols_left(.c = "WT,AGE,CRCL"),
  r_file = "foo.R", output_file = "foo.tex"
) %>% wrap()
```

\clearpage

# Handle wide columns

## `descr is` taking over the table
```{r,results = "asis"}
ptable <- readRDS("datasets/ptable.RDS")

stable(ptable) %>% wrap()
```


## Limit `descr` to 5 cm

```{r, results = "asis"}
stable(
  ptable, 
  align = cols_center(descr = col_ragged(5))
) %>% wrap()
```


\clearpage

# Identify a summary row

We can point to one or more rows and style it up as a "summary row"

```{r}
df.total <- readRDS(file = "datasets/with-total.RDS")
df.total
```


```{r, results = "asis"}
stable(
  df.total, 
  units = ys_get_unit(spec, parens = TRUE),
  align = cols_center(STUDY = 'l'),
  r_file  = "foo.R", output_file = "output.tex",
  col_rename = c("Protocol no."  = "STUDY"),
  notes = "WT: weight; CRCL: creatinine clearance",
  sumrows = sumrow(
    df.total$STUDY == "all", 
    label = "All Studies", 
    bold = TRUE
  )
) %>% wrap()
```


\clearpage

# Save the table to file 

- There is a output file attribute on the text that is returned

```{r}
tab <- stable(data, output_file = "foo.tex")
str(tab)
```

This can be used to save 

```{r}
stable_save(tab)

file.exists("foo.tex")
```


Oops ...
```{r}
try(stable_save(as.character(tab)))
```

\clearpage

# Fontsize

- Where's my glasses?

```{r,results = 'asis'}
data %>% stable(fontsize = "tiny") %>% wrap()
```


\clearpage

# Row space

```{r,results = 'asis'}
data %>% slice(1:3) %>% stable() %>% wrap()
data %>% slice(1:3) %>% stable(row_space = 0.9) %>% wrap()
data %>% slice(1:3) %>% stable(row_space = 2) %>% wrap()
```
\clearpage

# Col space

```{r,results = 'asis'}
data %>% stable(col_space = 20) %>% wrap()
```
